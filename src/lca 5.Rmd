```{r}
data <- read.csv("diabetes_012_health_indicators_BRFSS2015.csv")

library(dplyr)
data_bad_MH <- data |> 
  filter(MentHlth > 15) # Focus on groups with poor mental health

data_no_HC <- data_bad_MH |> 
  filter(AnyHealthcare == 1) |> 
  select(-AnyHealthcare)# Compare with having HC

data_HC <- data_bad_MH |> 
  filter(AnyHealthcare == 0) |> 
  select(-AnyHealthcare)
```

```{r}
# test 1: HC


# Load library
library(poLCA)

# new data
data2 <- data_no_HC

# Binning process
data2$BMI <- ifelse(data2$BMI >= 18 & data2$BMI <= 25, 1, 0)
data2$GenHlth <- ifelse(data2$GenHlth %in% 1:3, 1, 0)
data2$PhysHlth <- ifelse(data2$PhysHlth < 15, 1, 0)

# Exclude specific columns
excluded_columns <- c("MentHlth", "Sex", "Age", "Income", "Education")
selected_columns <- setdiff(colnames(data2), excluded_columns)

# Select variables for LCA (categorical or ordinal variables only)
lca_data <- data2[, selected_columns]

# Ensure all variables are treated as factors
lca_data <- lapply(lca_data, as.factor)
lca_data <- as.data.frame(lca_data)

# Run LCA for 3 classes
set.seed(123)
optimal_classes <- 5
lca_model <- poLCA(cbind(HighBP, HighChol, CholCheck, Smoker, Stroke, HeartDiseaseorAttack, 
                         PhysActivity, Fruits, Veggies, HvyAlcoholConsump, NoDocbcCost, 
                         GenHlth, DiffWalk, BMI, PhysHlth) ~ 1, 
                   data = lca_data, nclass = optimal_classes, 
                   maxiter = 1000, nrep = 10, verbose = TRUE)

# Summarize the model
summary(lca_model)

```


```{r}
# Load necessary libraries
library(psych)  # For factor analysis functions

# new data
data2 <- data_no_HC

# Binning process
data2$BMI <- ifelse(data2$BMI >= 18 & data2$BMI <= 25, 1, 0)
data2$GenHlth <- ifelse(data2$GenHlth %in% 1:3, 1, 0)
data2$PhysHlth <- ifelse(data2$PhysHlth < 15, 1, 0)

# Exclude specific columns
excluded_columns <- c("MentHlth", "Sex", "Age", "Income", "Education")
selected_columns <- setdiff(colnames(data2), excluded_columns)
data_selected <- data2[, selected_columns]

# Check for missing values and handle them (if necessary)
# Example: Replace missing values with the mean
data_selected <- data.frame(lapply(data_selected, function(x) {
  if (is.numeric(x)) {
    x[is.na(x)] <- mean(x, na.rm = TRUE)
  }
  return(x)
}))

# Assess the suitability of the data for factor analysis
# Bartlett's test of sphericity and KMO measure of sampling adequacy
bartlett_result <- cortest.bartlett(cor(data_selected), n = nrow(data_selected))
kmo_result <- KMO(cor(data_selected))

cat("Bartlett's Test of Sphericity:\n")
print(bartlett_result)

cat("\nKMO Measure of Sampling Adequacy:\n")
print(kmo_result)

# Run factor analysis
# Specify the number of factors (e.g., 3) and the rotation method (e.g., varimax)
fa_result <- fa(data_selected, nfactors = 3, rotate = "varimax")

# View the factor analysis results
print(fa_result)

# Scree plot for number of factors
fa.parallel(data_selected, fa = "fa")

# Visualize factor loadings
fa.diagram(fa_result)

```


```{r}
# Load necessary libraries
library(survival)
library(survminer)

# Load the data
data <- read.csv("diabetes_012_health_indicators_BRFSS2015.csv")

# Assume 'Age' is the time variable and 'Diabetes_012' is the event variable (adjust as needed)
data$event <- ifelse(data$Diabetes_012 == 2, 1, 0) # Event occurs when diabetes status is 2

# Fit the Cox proportional hazards model
cox_model <- coxph(Surv(Age, event) ~ BMI + HighBP + HighChol + Smoker, data = data)

# Summary of the model
summary(cox_model)

# Generate survival curves
surv_curves <- survfit(cox_model)

# Plot the survival curves
ggsurvplot(surv_curves, data = data, pval = TRUE, risk.table = TRUE,
           title = "Survival Curves for Diabetes",
           xlab = "Age", ylab = "Survival Probability")

```

